name: Build and Push Stealthy MCP Image

on:
  push:
    branches:
      - main  # å½“ä½ å‘ main åˆ†æ”¯æ¨é€æ—¶è§¦å‘
  workflow_dispatch: # å…è®¸ä½ æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: ğŸ“ Patch package.json with stealth dependencies
        run: |
          # ä½¿ç”¨ jq (ä¸€ä¸ªå‘½ä»¤è¡ŒJSONå¤„ç†å™¨) æ¥åŠ¨æ€æ·»åŠ ä¾èµ–
          # è¿™æ¯”ç”¨ sed æ›´å¥å£®å’Œå®‰å…¨
          jq '.dependencies."playwright-extra" = "^4.3.6" | .dependencies."playwright-extra-plugin-stealth" = "^2.11.2"' package.json > package.json.tmp && mv package.json.tmp package.json
          echo "âœ… Patched package.json:"
          cat package.json

      - name: ğŸ“ Patch server.ts to use playwright-extra
        run: |
          # ä½¿ç”¨ sed è¿›è¡Œæ–‡æœ¬æ›¿æ¢ï¼Œè¿™æ˜¯æœ€ç›´æ¥çš„æ–¹å¼
          # å®šä¹‰è¦æ’å…¥çš„ä»£ç å—ã€‚æ³¨æ„å¤šè¡Œæ–‡æœ¬çš„å¤„ç†å’Œè½¬ä¹‰
          PATCH_CODE="import { chromium } from 'playwright-extra';\nimport stealthPlugin from 'playwright-extra-plugin-stealth';\nimport type { Page, BrowserContext, Browser, CDPSession } from 'playwright-core';\n\nchromium.use(stealthPlugin());"
          
          # åœ¨ src/server.ts ä¸­ï¼Œæ‰¾åˆ°åŸå§‹ import è¯­å¥å¹¶ç”¨æˆ‘ä»¬çš„æ–°ä»£ç å—æ›¿æ¢å®ƒ
          # The original line might span multiple lines in some formats, so we use a flexible pattern
          sed -i.bak "/import { chromium, Page, BrowserContext, Browser, CDPSession } from 'playwright';/c\\$PATCH_CODE" src/server.ts
          
          echo "âœ… Patched src/server.ts:"
          head -n 10 src/server.ts # æ˜¾ç¤ºæ–‡ä»¶çš„å‰10è¡Œä»¥ç¡®è®¤ä¿®æ”¹

      - name: ğŸ”„ Update package-lock.json
        run: |
          # è¿è¡Œ npm install æ¥åŸºäºä¿®æ”¹åçš„ package.json ç”Ÿæˆæ–°çš„ package-lock.json
          # è¿™å¯¹äº `npm ci` åœ¨ Dockerfile ä¸­æ­£ç¡®å·¥ä½œè‡³å…³é‡è¦
          npm install
          echo "âœ… Updated package-lock.json"

      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/playwright-mcp-stealthy:latest
          # ä¹Ÿå¯ä»¥æ·»åŠ å…¶ä»– tags, æ¯”å¦‚åŸºäº commit SHA çš„ç‰ˆæœ¬å·
          # tags: |
          #  ${{ secrets.DOCKERHUB_USERNAME }}/playwright-mcp-stealthy:latest
          #  ${{ secrets.DOCKERHUB_USERNAME }}/playwright-mcp-stealthy:${{ github.sha }}

      - name: âœ… Build summary
        run: echo "ğŸ‰ Successfully built and pushed image to ${{ secrets.DOCKERHUB_USERNAME }}/playwright-mcp-stealthy:latest"
